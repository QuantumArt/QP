## Краткое описание

Приложение для применения ранее записанных действий в QP.  
Как писать и воспроизводить - см. инструкцию администратора QP.  

## Нюансы сборки проекта

Для сборки проекта в Docker используется Dockerfile в директории QP8.ConsoleDbUpdate.  
Перед его использованием обязательно выполнить файл под именем `create_tar.sh` в корне решения.  

При сборке через CI-решения перед запуском docker-файла требуется сделать шаг в котором будет выполняться команда из файла `create_tar.sh` (по аналогии с тем как сделано в QP).  

## Использование  

### Общие правила

Все именованные аргументы передаются через пробел, например `--mode xml`.  

Для работы ПО требуется передать ряд обязательных аргументов:  

- `-m|--mode` - режим работы с файлами, определяет какой из обработчиков файлов будет использован. Поддерживаются xml и csv. Пример `--mode xml`;  
- `customer_code|connection_string` - customer_code или строка подключения к БД QP. Неименованный параметр.

### Режим передачи файла  

Файл с действиями можно передать одним из следующих способов:  

- piped input - передать поток с данными файла через pipe или перенаправление потока в консоли;  
- аргумент `-p|--path` - путь к директории или файлу с действиями для воспроизведения. При использовании этого аргумента будут обработы все файлы в директории. Субдиректории будут проигнорированы. Можно указать путь к директории, например `--path /qpactions/`, путь к файлу, например `--path /qpactions/action.xml`, пути к директориям, например `--path /qpactions1/ --path /qpactions2/`, пути к файлам, например `--path /qpactions1/action1.xml --path /qpactions2/action2.xml` и пути к директориям и файлам, например `--path /qpactions1/ --path /qpactions2/action.xml`. В директориях происходит поиск файлов по расширению в зависимости от выбранного режима (см. `-m|--mode`). Если передать файл с неверным расширением, то он будет проигнорирован;  

### Способы настройки  

Корректно настроить приложение на работу с QP можно одним из следующих способов:  

- передача строки подключения в виде неименованного аргумента - в этом случае приложение выполнит подключение к БД и применит изменения в этой базе. Строка подключения как правило содержит пробелы, передавать её в качестве аргумента стоит предварительно обрамив кавычками;  
- передача customer_code-а - в случае передачи customer_code-а вместо строки подключения возможны следующие варианты:  
    - передача аргумента `-c|--config` - путь к файлу конфигурации QP. В этом случае ПО проанализирует файл конфигурации и попытается найти строку подключения по переданному customer_code-у;  
    - передача аргументов `-r|--remoteConfig` и `-j|--jwt` - url к сервису конфигурации QP и JWT-токен для доступа к нему соответственно. В этом случае ПО запросит в сервисе конфигурации строку подключения по переданному customer_code-у;  
    - не указывать дополнительных аргументов - в этом случае сервис попытается обратиться в реестр Windows и найти там строку подключения для указанного customer_code-а. Этот способ работает ТОЛЬКО в Windows. Для корректной работы этого способа требуется запускать ПО на том же устройстве, на котором запущена QP.  

### Дополнительные настройки  

- `-t|--type` - тип используемой с QP БД (0 - SqlServer, 1 - Postgres). Используется только при передаче строки подключения или customer_code-а без дополнительных аргументов. В остальных случаях тип БД берётся из используемого источника конфигурации;  
- `-v|--verboseLevel` - уровень логирования. Поддерживаются следующие уровни `[v|vv|vvv]:[error|warning|info]`;  
- `-s|--silent` - при передаче этого аргумента приложение не будет запрашивать подтверждение пользователя и выводить конфигурацию на экран;  
- `--disablePipedInput` - принудительно отключается `piped-input`. Полезно для использования приложения в docker не в интерактивном режиме;  
- `-h|--help` - показывает справку о работе приложения.  

### Настройки зависимые от режима работы (см. `-m|--mode`)  

#### CSV  

- `-e|--encoding` - кодировка экспортированного файла. Должна совпадать с кодировкой выбранной при экспорте из QP. По умолчанию `windows-1251`;  
- `-l|--culture` - культура в которой сохранены данные файлы. По умолчанию `ru-RU`;  
- `-u|--updateExisting` - признак необходимости обновлять существующие статьи. По умолчанию `false`.  

#### XML  

- `-g|--generateIds` - генерировать ли новые идентификаторы. Возможные значения `field|content`, генерируют новые значения для полей и контентов соответственно. По умолчанию отключено для всех;  
- `-d|--disable` - тоже самое, что и `-g|--generateIds`;  
- `--useGuid` - указатель, что требуется использовать GUID статей. При отключённой опции используются идентификаторы статей;  
- `--disableDataIntegrity` - отключить проверку на повторное выполнение XML.

### Нюансы запуска в Docker  

При использовании приложения из Docker есть ряд нюансов о которых стоит помнить.  
Во первых для использования файлов требуется подключить `volume` с ними, например так `docker run -v /host_path/:/container_path/ --rm ImageName Args`, после чего передавать `container_path` в качестве отправной точки в аргументах. Однако стоит помнить, что по умолчанию приложение работает в интерактивном режиме и запросит у пользователя подтверждение. Чтобы этого избежать нужно передать в качестве аргумента ключ `-s|--silent`.  
Во вторых следует помнить, что по умолчанию контейнер запускается не в интерактивном режиме, следовательно приложение будет работать в `pipe-mode` и ожидать передачи файла прямо в себя через pipe или перенаправление в консоли. Для запуска приложения в интерактивном режиме следует использовать ключи `-it`, например `docker run -v /host_path/:/container_path/ --rm -it ImageName Args`.  
Если требуется запустить контейнер без интерактивного режима, но с использованием файлов действия или экспорта из QP именно в docker, то следует передать в качестве аргумента приложения ключ `--disablePipedInput`. В этом случае приложение запущенное не в интерактивном режиме не будет ожидать piped input или перенаправления файла, а будет использовать ключи `-p|--path` или `-c|--config`.  